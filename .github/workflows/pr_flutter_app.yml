on:
  pull_request:
    paths:
      - .github/workflows/pr_flutter_app.yml
      - script/updateAndroidVersions.gradle
      - version.json
  workflow_dispatch:

jobs:
  doc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3

      - name: Set environment variables from version.json
        run: |
          echo "FLUTTER_VERSION=$(jq -r '.flutter.version' config/version.json)" >> $GITHUB_ENV
          echo "FLUTTER_CHANNEL=$(jq -r '.flutter.channel' config/version.json)" >> $GITHUB_ENV

      - name: Setup Flutter
        uses: flutter-actions/setup-flutter@f59ff7bdbb3127f71345907452e04be356c370f5 # v2
        with:
          cache: true
          channel: ${{ env.FLUTTER_CHANNEL }}
          version: ${{ env.FLUTTER_VERSION }}

      - name: Create test application
        run: |
          flutter create test_app

      - name: Update default Android platform versions in Flutter
        working-directory: test_app/android
        run: |
          cat ../../script/updateAndroidVersions.gradle >> app/build.gradle
          ./gradlew --warning-mode all updateAndroidVersions

      - name: Setup Cue for JSON validation
        uses: cue-lang/setup-cue@v1.0.0

      - name: Validate version.json
        run: cue vet config/version.cue config/version.json
